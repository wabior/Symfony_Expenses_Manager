{% extends 'base.html.twig' %}

{% block title %}Wydatki{% endblock %}

{% block content %}
	<div class="container mx-auto px-4 py-8 animate-fade-in-up">
		<!-- Navigation and Actions -->
		<div class="card-modern p-6 mb-6">
			<div
				class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
				<!-- Month Navigation -->
				<div class="flex items-center space-x-3" aria-label="Month navigation">
					<a href="{{ path('expenses', { year: prevYear, month: prevMonth }) }}" class="btn-outline">
						<svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewbox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
						</svg>
						Poprzedni
					</a>

					<div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg">
						{{ month }}
						-
						{{ year }}
					</div>

					<a href="{{ path('expenses', { year: nextYear, month: nextMonth }) }}" class="btn-outline">
						Następny
						<svg class="w-5 h-5 ml-2 inline" fill="none" stroke="currentColor" viewbox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
						</svg>
					</a>
				</div>

				<!-- Actions -->
				<div class="flex flex-wrap gap-3">
					{% include 'components/button.html.twig' with {
						href: path('expenses_add'),
						text: 'Dodaj wydatek',
						icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>'
					} %}
					<form action="{{ path('expenses_import_recurring', { year: year, month: month }) }}" method="post" style="display: inline;">
						<input type="hidden" name="_token" value="{{ csrf_token('import_recurring') }}">
						{% include 'components/button.html.twig' with {
							text: 'Importuj cykliczne',
							icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>',
							class: 'btn-secondary',
							type: 'submit',
							additional_class: 'cursor-pointer'
						} %}
					</form>
				</div>
			</div>
		</div>

		<!-- Expenses Table -->
		<div class="table-container">
			<table class="min-w-full leading-normal">
				<thead>
					<tr>
						{% set headers = ['Data', 'Nazwa', 'Kwota', 'Kategoria', 'Cykliczność', 'Status', 'Akcje'] %}
						{% for header in headers %}
							<th class="table-header">{{ header }}</th>
						{% endfor %}
					</tr>
				</thead>
				<tbody>
					{% for occurrence in expenses %}
						{% set expense = occurrence.expense %}
						{% set itemId = occurrence.id %}
						{% set itemDate = occurrence.occurrenceDate %}
						{% set itemStatus = occurrence.paymentStatus %}

						<tr id="occurrence-{{ itemId }}" {% if expense.isRecurring %} class="recurring-expense" {% endif %} class="hover:bg-blue-50/50 transition-colors duration-200">
							<td class="table-cell font-medium">
								<div class="flex items-center">
									<svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
									</svg>
									{{ itemDate|date('d.m.Y') }}
								</div>
							</td>
							<td class="table-cell">
								<div class="flex items-center">
									<div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-lg flex items-center justify-center mr-3">
										<span class="text-white text-xs font-bold">{{ expense.name|slice(0, 1)|upper }}</span>
									</div>
									<a href="{{ path('expenses_edit', {id: itemId}) }}">
										{{ expense.name }}
									</a>
								</div>
							</td>
							<td class="table-cell font-semibold text-end ">
								{{ occurrence.amount|number_format(2, ',', ' ') }}
								zł
							</td>
							<td class="table-cell">
								{% if expense.category %}
									<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
										{{ expense.category.name }}
									</span>
								{% else %}
									<span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm">
										Brak kategorii
									</span>
								{% endif %}
							</td>
							<td class="table-cell">
								{% if expense.isRecurring %}
									<span>{{ expense.recurringFrequency ?? ''}}</span>
								{% endif %}
							</td>
							<td class="table-cell status-cell cursor-pointer relative" data-id="{{ itemId }}" data-type="occurrence">
								<div class="flex items-center justify-between">
									<span class="status-text font-semibold
											{% if itemStatus == 'unpaid'%} status-unpaid {% endif %}
											{% if itemStatus == 'paid'%} status-paid {% endif %}
											{% if itemStatus == 'partially_paid'%} status-partially-paid {% endif %}"
										>
										{% if itemStatus == 'paid' %}
											<svg class="w-4 h-4 mr-1 inline" fill="currentColor" viewbox="0 0 20 20">
												<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
											</svg>
										{% elseif itemStatus == 'unpaid' %}
											<svg class="w-4 h-4 mr-1 inline" fill="currentColor" viewbox="0 0 20 20">
												<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
											</svg>
										{% else %}
											<svg class="w-4 h-4 mr-1 inline" fill="currentColor" viewbox="0 0 20 20">
												<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
											</svg>
										{% endif %}
										{{ itemStatus|replace({'_': ' '})|title }}
									</span>
								</div>
								<select class="status-select absolute right-2 top-2 p-2 hidden w-full bg-white border border-gray-300 rounded-lg shadow-lg form-select">
									{% set statuses = {
										'unpaid': 'Nieopłacony',
										'paid': 'Opłacony',
										'partially_paid': 'Częściowo opłacony'
									} %}
									{% for value, label in statuses %}
										<option value="{{ value }}" {% if itemStatus == value %} selected {% endif %}>
											{{ label }}
										</option>
									{% endfor %}
								</select>
							</td>
							<td class="table-cell text-center">
								<form action="{{ path('expenses_delete', {id: itemId}) }}" method="post" class="inline-block" onsubmit="return confirm('Czy na pewno chcesz usunąć ten wydatek?')">
									<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ itemId) }}">
									<button type="submit" class="text-gray-500 hover:text-red-600 p-2 rounded-lg transition-colors duration-200" title="Usuń wydatek">
										<svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
										</svg>
									</button>
								</form>
							</td>
						</tr>
					{% else %}
						<tr>
							<td colspan="{{ headers|length }}" class="table-cell text-center py-12">
								<div class="flex flex-col items-center">
									<svg class="w-16 h-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
									</svg>
									<p class="text-gray-500 text-lg font-medium">Brak wydatków w tym miesiącu</p>
									<p class="text-gray-400">Dodaj pierwszy wydatek, aby zacząć śledzenie.</p>
								</div>
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
{% endblock %}
